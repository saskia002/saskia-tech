user                nginx;
worker_processes    auto;
error_log           /var/log/nginx/error.log;
pid                 /run/nginx.pid;


events {
    worker_connections 1024;
}


http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    add_header Content-Security-Policy "
                    default-src 'none';
                    base-uri 'none';
                    font-src 'none';
                    form-action 'none';
                    frame-ancestors 'none';
                    frame-src 'none';
                    img-src 'none';
                    object-src 'none';
                    script-src 'none';
                    script-src-attr 'none';
                    style-src 'none';
                    upgrade-insecure-requests
                ";
    proxy_cookie_path /                     "/; HttpOnly; Secure; SameSite=Strict";
    add_header Referrer-Policy              "no-referrer-when-downgrade";
    add_header X-Frame-Options              "SAMEORIGIN" always;
    add_header X-Content-Type-Options       "nosniff" always;
    add_header X-XSS-Protection             "1; mode=block" always;
    add_header Strict-Transport-Security    "max-age=31536000; includeSubDomains" always;
    add_header Permissions-Policy           "geolocation=(), microphone=(), camera=(), payment=(), fullscreen=(self)";
    add_header Access-Control-Allow-Methods "GET, POST, DELETE, PUT, OPTIONS";
    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization";
    add_header Access-Control-Allow-Origin  $http_origin;

    proxy_hide_header       X-Powered-By;
    server_tokens           off;
    sendfile                on;
    tcp_nopush              on;
    tcp_nodelay             on;
    keepalive_timeout       65;
    types_hash_max_size     4096;
    client_max_body_size    16M;
    types_hash_bucket_size  64;

    gzip                on;
    gzip_vary           on;
    gzip_proxied        any;
    gzip_comp_level     6;
    gzip_buffers        16 8k;
    gzip_http_version   1.1;
    gzip_min_length     256;
    gzip_types          application/atom+xml
                        application/geo+json
                        application/javascript
                        application/x-javascript
                        application/json
                        application/ld+json
                        application/manifest+json
                        application/rdf+xml
                        application/rss+xml
                        application/xhtml+xml
                        application/xml
                        font/eot
                        font/otf
                        font/ttf
                        image/svg+xml
                        text/css
                        text/javascript
                        text/plain
                        text/xml
                        text/html
                        ;


    upstream web {
        server 127.0.0.1:3000 max_fails=3 fail_timeout=5s;
    }

    server {
        listen [::]:80 default_server;
        listen 80 default_server;
        return 444;
    }

    server {
        server_name saskia002.ee;

        location / {
                proxy_pass          http://web;
                proxy_http_version  1.1;
                proxy_set_header    Upgrade             $http_upgrade;
                proxy_set_header    Connection          'upgrade';
                proxy_set_header    Host                $host;
                proxy_cache_bypass  $http_upgrade;
                proxy_set_header    X-Real-IP           $remote_addr;
                proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
                proxy_set_header    X-Forwarded-Proto   $scheme;
                add_header          Access-Control-Allow-Methods "GET, POST, OPTIONS";

                add_header Content-Security-Policy "
                                default-src 'self';
                                base-uri 'self';
                                font-src 'self' data:;
                                form-action 'self';
                                frame-ancestors 'self';
                                frame-src 'self';
                                img-src 'self' data:;
                                object-src 'none';
                                script-src 'self' 'unsafe-inline';
                                script-src-attr 'none';
                                style-src 'self' 'unsafe-inline';
                                upgrade-insecure-requests
                            ";
        }

        listen [::]:443 ssl;
        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/saskia002.ee/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/saskia002.ee/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }


    server {
        if ($host = saskia002.ee) {
            return 301 https://$host$request_uri;
        }

        listen       80;
        listen       [::]:80;
        server_name saskia002.ee;
        return 404;
    }


    server {
        server_name saskia.tech;

        location / {
                proxy_pass          http://web;
                proxy_http_version  1.1;
                proxy_set_header    Upgrade             $http_upgrade;
                proxy_set_header    Connection          'upgrade';
                proxy_set_header    Host                $host;
                proxy_cache_bypass  $http_upgrade;
                proxy_set_header    X-Real-IP           $remote_addr;
                proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
                proxy_set_header    X-Forwarded-Proto   $scheme;
                add_header          Access-Control-Allow-Methods "GET, POST, OPTIONS";

                add_header Content-Security-Policy "
                                default-src 'self';
                                base-uri 'self';
                                font-src 'self' data:;
                                form-action 'self';
                                frame-ancestors 'self';
                                frame-src 'self';
                                img-src 'self' data:;
                                object-src 'none';
                                script-src 'self' 'unsafe-inline';
                                script-src-attr 'none';
                                style-src 'self' 'unsafe-inline';
                                upgrade-insecure-requests
                            ";
        }

        listen [::]:443 ssl;
        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/saskia.tech/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/saskia.tech/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }


    server {
        if ($host = saskia.tech) {
            return 301 https://$host$request_uri;
        }

        listen       80 ;
        listen       [::]:80;
        server_name saskia.tech;
        return 404;
    }

}
